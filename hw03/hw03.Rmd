---
title: 'Homework #3'
author: "Kaitlyn Harper"
date: "September 28, 2017"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load data and packages
```{r load_data, message=FALSE}

# Load packages
library(tidyverse)
library(knitr)
library(kableExtra)

# Load gapminder dataset
library(gapminder)
data("gapminder")

#View data (just to make sure it's there)
head(gapminder)

```

<a href="#top">Back to top</a>

## Look at the spread of GDP per capita within the continents.

```{r max_min, results='asis'}

min_max = gapminder %>% 
  group_by(continent) %>% 
  summarise(maxGDP = max(gdpPercap), 
            minGDP = min(gdpPercap),
            meanGDP = mean(gdpPercap),
            sdGDP = sd(gdpPercap))

min_max %>% 
  kable(col.names = c("Continent", "Max GDP", "Min GDP", "Mean GDP", "SD GDP"), format = "html",
        caption = "Table 1. Spread of GDP per capita within each continent") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)

```

```{r spreadPlot, echo=TRUE}

gapminder %>%
  ggplot(aes(x=continent, y=gdpPercap)) +
  geom_boxplot(aes(fill = continent), show.legend = FALSE) +
  labs(x = "Country", y = "GDP per capita", title = "Spread of GDP per capita within each continent") +
  theme_dark(base_size = 13, base_family = "Courier")

rm(min_max)

```

<a href="#top">Back to top</a>

## How is life expectancy changing over time on different continents?  

```{r LEtable, echo=TRUE}

gapMeanLE = gapminder %>%
  group_by(continent, year) %>% 
  summarise(meanLE = mean(lifeExp))

gapMeanLE = gapMeanLE %>%
  group_by(continent) %>% 
  summarise(deltaLE = round(meanLE[year==2007] - meanLE[year==1952], 2))

gapMeanLE %>% 
  kable(col.names = c("Continent", "Years"), align = "c", format = "html", 
        caption = "Table 2. Increases in life expectancy (in years) from 1952-2007") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = T)

```


```{r LEplot, echo=TRUE}

gapminder %>%
  group_by(continent, year) %>% 
  summarise(meanLE = mean(lifeExp)) %>% 
  ggplot(aes(x=year, y=meanLE)) +
  geom_smooth(method="loess", aes(color=continent), se=FALSE) +
  scale_color_discrete("Continents") +
  labs(x="Year", y= "Mean Life Expectancy (Years)", title="Life expectancy changes in each continent, 1952-2007") +
  theme_light(base_family = "Palatino") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_blank())

rm(gapMeanLE) # cleanup

```

As we can see from the plot, all of the countries increased their life expectancies from 1952 to 2007. The table shows us that Asia had the largest change in life expectancy over this time period, with an increase of 24 years. Oceania had the smallest change in life expectancy (~11 years increase), but they already had the highest life expectancy to begin with and remained the life expectancy leader throughout the entire time period.

<a href="#top">Back to top</a>

## Report the abundance of countries with low life expectancy over time by continent
**Details: Compute some measure of worldwide life expectancy – you decide – a mean or median or some other quantile or perhaps your current age. Then determine how many countries on each continent have a life expectancy less than this benchmark, for each year.**

```{r lowLE, echo=TRUE}

# Find the global mean and median life expectancies
summary(gapminder$lifeExp)[3:4] 

# median= ~59, mean= ~60
# Since they're about the same, I'll just use the mean

# Make table for countries with low LE
gapLowLE <- gapminder %>% 
    mutate(LEcat=c("low", "high")[(lifeExp>summary(gapminder$lifeExp)[[4]]) + 1]) %>% 
    select(1:3, 7) %>% 
    group_by(continent, year) %>% 
    summarise(numberLow = sum(LEcat=="low"), percentLow = 100*round(sum(LEcat=="low")/n(), 2))

# Plot percentage of countries with life exp lower than 60 years
gapLowLE %>% 
  ggplot(aes(x=year, y=percentLow)) +
  geom_bar(stat="identity") +
  facet_wrap(~ continent) +
  labs(x="Year", y="Percent of total countries", title="Percentage of countries with life expectancies lower than 60 years, by continent") +
  theme(strip.background = element_rect(fill="cornflower blue"),
        axis.title = element_text(size=14, face="italic"),
        strip.text = element_text(size=14, face="bold"))

# Make data table of countries and percentages

  # Create new data frame
  tab1 = data.frame(
  Year = as.vector(unique(gapminder$year)),
  Africa = as.vector(gapLowLE$percentLow[which(gapLowLE$continent=="Africa")]),
  Americas = as.vector(gapLowLE$percentLow[which(gapLowLE$continent=="Americas")]),
  Europe = as.vector(gapLowLE$percentLow[which(gapLowLE$continent=="Europe")]),
  Asia = as.vector(gapLowLE$percentLow[which(gapLowLE$continent=="Asia")]),
  Oceania = as.vector(gapLowLE$percentLow[which(gapLowLE$continent=="Oceania")])
  )

  # Format using kable
  knitr::kable(tab1, format = "html", caption = "Table 3. Percentage of countries per continent with life expectancy lower than 60 years")

rm(tab1)

```

<a href="#top">Back to top</a>

## Extra exploration
**Details: Find countries with interesting stories. Open-ended and, therefore, hard. Promising but unsuccessful attempts are encouraged. This will generate interesting questions to follow up on in class.**

<a href="#top">Back to top</a>

## Reflection  
I found this assignment to be way more difficult than the previous two assignments, probably because it was more open-ended and less just plug and chug. There were a couple parts of my code that I think are pretty messy and I could clean up:

1. 
```{r eg1, echo=TRUE}
gapMeanLE = gapminder %>%
  group_by(continent, year) %>% 
  summarise(meanLE = mean(lifeExp))

gapMeanLE = gapMeanLE %>%
  group_by(continent) %>% 
  summarise(deltaLE = round(meanLE[year==2007] - meanLE[year==1952], 2))
```

  In this chunk, I had to basically do two rounds of dplyr functions to get the output I wanted. I couldn't figure out how to summarise once and then summarise again, using the data I created from the first summarise function. I'm not sure if it's possible, but I feel like this was repetitive and could be way cleaner.
  
2. 
```{r eg2, echo=TRUE}
  tab1 = data.frame(
  Year = as.vector(unique(gapminder$year)),
  Africa = as.vector(gapLowLE$percentLow[which(gapLowLE$continent=="Africa")]),
  Americas = as.vector(gapLowLE$percentLow[which(gapLowLE$continent=="Americas")]),
  Europe = as.vector(gapLowLE$percentLow[which(gapLowLE$continent=="Europe")]),
  Asia = as.vector(gapLowLE$percentLow[which(gapLowLE$continent=="Asia")]),
  Oceania = as.vector(gapLowLE$percentLow[which(gapLowLE$continent=="Oceania")])
  )
```

In this chunk, I wanted to rearrange data from the previous data table and put it in a new format. Again, this feels really repetitive and I'm sure there was a better way to do this, but I couldn't figure out how. Apply functions perhaps? Any insight would be helpful :) 

Other than that, I enjoyed the assignment and had fun formatting my plots with features I hadn't really known about previously (like how to format the title, text, etc.) It was also fun to start to ask random questions about the data and explore it how we would normally, instead of just answering simple, cookie cutter questions. I used ?function quite a bit to find out more about various functions, as well as explored some questions on Stack Overflow, like [this one](https://stackoverflow.com/questions/29904974/conditionally-count-in-dplyr) that has to do with counting values conditionally using dplyr.
